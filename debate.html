<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debate Battle - Voice Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a2a, #1a1a4a);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-y: auto;
        }
        
        /* Animated Background */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            animation: particle-float 15s infinite linear;
        }
        
        @keyframes particle-float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Debate Container */
        .debate-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }
        
        /* Header */
        .debate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(30, 30, 70, 0.8);
            border-radius: 20px;
            border: 2px solid rgba(142, 78, 231, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .start-debate-btn {
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.3);
            border: 2px solid #00ff88;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .start-debate-btn:hover {
            background: rgba(0, 255, 136, 0.5);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }
        
        .end-debate-btn {
            padding: 10px 20px;
            background: rgba(255, 0, 128, 0.3);
            border: 2px solid #ff0080;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .end-debate-btn:hover {
            background: rgba(255, 0, 128, 0.5);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.4);
        }
        
        .topic-display {
            flex: 1;
            text-align: center;
        }
        
        .topic-title {
            font-size: 1.4rem;
            color: #8e4ee7;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .topic-statement {
            font-size: 1.6rem;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(142, 78, 231, 0.5);
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .score-box {
            text-align: center;
            padding: 10px 20px;
            background: rgba(20, 20, 50, 0.8);
            border-radius: 15px;
            border: 2px solid;
            min-width: 120px;
        }
        
        .user-score-box { border-color: #00b7ff; }
        .ai-score-box { border-color: #ff0080; }
        
        .score-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .score-value {
            font-size: 2rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .user-score { color: #00b7ff; }
        .ai-score { color: #ff0080; }
        
        .timer-container {
            text-align: center;
        }
        
        .timer-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .timer {
            font-size: 2.5rem;
            font-family: 'Orbitron', monospace;
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        
        .timer.warning { color: #ff0080; }
        
        /* Voice Status */
        .voice-status {
            padding: 12px 20px;
            background: rgba(30, 30, 70, 0.8);
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            border: 2px solid rgba(142, 78, 231, 0.4);
        }
        
        .voice-active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .voice-inactive {
            background: rgba(255, 0, 128, 0.2);
            border-color: #ff0080;
            color: #ff0080;
        }
        
        /* Debate Arena */
        .debate-arena {
            display: flex;
            justify-content: space-between;
            flex: 1;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Participant Panels */
        .participant {
            flex: 1;
            background: rgba(30, 30, 70, 0.7);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .participant.active {
            border-color: #8e4ee7;
            box-shadow: 0 0 30px rgba(142, 78, 231, 0.3);
        }
        
        .participant.speaking {
            border-color: #00ff88;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.5);
            animation: speaking-pulse 1.5s infinite;
        }
        
        @keyframes speaking-pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 0 50px rgba(0, 255, 136, 0.7); }
        }
        
        .participant-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid;
        }
        
        .user-header { border-color: #00b7ff; }
        .ai-header { border-color: #ff0080; }
        
        .avatar-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            border: 3px solid;
            overflow: hidden;
            position: relative;
        }
        
        .user-avatar { 
            border-color: #00b7ff; 
            background: rgba(0, 183, 255, 0.1);
        }
        .ai-avatar { 
            border-color: #ff0080; 
            background: rgba(255, 0, 128, 0.1);
        }
        
        .character-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .character-emoji {
            font-size: 3rem;
            position: absolute;
            background-color: aliceblue;
            border-radius: 50%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .speaking-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        
        .participant-info {
            flex: 1;
        }
        
        .participant-name {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .beginner-badge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .intermediate-badge {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }
        
        .expert-badge {
            background: rgba(255, 0, 128, 0.2);
            color: #ff0080;
            border: 1px solid #ff0080;
        }
        
        .human-badge {
            background: rgba(0, 183, 255, 0.2);
            color: #00b7ff;
            border: 1px solid #00b7ff;
        }
        
        .side-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .pro-side { 
            background: rgba(0, 255, 136, 0.2); 
            color: #00ff88; 
            border: 2px solid #00ff88;
        }
        .con-side { 
            background: rgba(255, 0, 128, 0.2); 
            color: #ff0080; 
            border: 2px solid #ff0080;
        }
        
        .voice-state {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Debate Content */
        .debate-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(20, 20, 50, 0.5);
            border-radius: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            animation: messageSlide 0.4s ease-out;
            position: relative;
            max-width: 95%;
        }
        
        @keyframes messageSlide {
            from { 
                transform: translateY(20px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }
        
        .user-message {
            background: rgba(0, 183, 255, 0.15);
            margin-left: auto;
            border-left: 4px solid #00b7ff;
            border-right: 2px solid rgba(0, 183, 255, 0.3);
        }
        
        .ai-message {
            background: rgba(255, 0, 128, 0.15);
            margin-right: auto;
            border-left: 4px solid #ff0080;
            border-right: 2px solid rgba(255, 0, 128, 0.3);
        }
        
        .system-message {
            background: rgba(142, 78, 231, 0.15);
            margin: 10px auto;
            text-align: center;
            border-left: 4px solid #8e4ee7;
            max-width: 80%;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-left: auto;
        }
        
        .message-text {
            line-height: 1.6;
            font-size: 1.1rem;
            white-space: pre-wrap;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255, 0, 128, 0.1);
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff0080;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #ff0080;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Voice Control Section */
        .voice-control-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: rgba(30, 30, 70, 0.8);
            border-radius: 20px;
            border: 2px solid rgba(142, 78, 231, 0.4);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            align-items: center;
        }
        
        .input-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .toggle-btn {
            padding: 10px 20px;
            background: rgba(30, 30, 70, 0.8);
            border: 2px solid #8e4ee7;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: rgba(142, 78, 231, 0.3);
            border-color: #00ff88;
        }
        
        .toggle-btn:hover:not(.active) {
            background: rgba(142, 78, 231, 0.2);
        }
        
        .record-btn {
            padding: 20px 50px;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #ff0080, #ff5500);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(255, 0, 128, 0.3);
        }
        
        .record-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 0, 128, 0.5);
        }
        
        .record-btn.recording {
            background: linear-gradient(45deg, #ff0000, #ff5555);
            animation: pulse 1.5s infinite;
        }
        
        .record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ff0080;
            font-size: 1.1rem;
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Text Input Area */
        .text-input-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #textArgument {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #8e4ee7;
            border-radius: 15px;
            background: rgba(20, 20, 50, 0.8);
            color: white;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        #textArgument:focus {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .send-text-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #8e4ee7, #ca4ee3);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .send-text-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(142, 78, 231, 0.5);
        }
        
        .send-text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Points Notification */
        .points-notification {
            position: fixed;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            animation: pointsFloat 1.5s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }
        
        @keyframes pointsFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Result Screen */
        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }
        
        .result-content {
            text-align: center;
            padding: 50px;
            border-radius: 30px;
            background: linear-gradient(135deg, #1a1a4a, #0a0a2a);
            border: 3px solid #8e4ee7;
            box-shadow: 0 0 50px rgba(142, 78, 231, 0.5);
            max-width: 600px;
            width: 90%;
            animation: popIn 0.5s;
        }
        
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .winner-title {
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #8e4ee7, #ff0080);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .final-score {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .user-final { color: #00b7ff; }
        .ai-final { color: #ff0080; }
        
        .score-breakdown {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            font-size: 1.2rem;
        }
        
        .result-message {
            font-size: 1.3rem;
            margin-bottom: 30px;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .play-again-btn {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }
        
        .home-btn {
            background: linear-gradient(45deg, #8e4ee7, #ca4ee3);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        @media (max-width: 1024px) {
            .debate-arena {
                flex-direction: column;
            }
            .participant {
                min-height: 40vh;
            }
            .topic-statement {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 768px) {
            .debate-header {
                flex-direction: column;
                gap: 20px;
            }
            .score-display {
                width: 100%;
                justify-content: space-around;
            }
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="particles-container" id="particlesContainer"></div>
    <div id="confettiContainer"></div>
    
    <div class="debate-container">
        <!-- Header -->
        <div class="debate-header">
            <div class="header-left">
                <button class="start-debate-btn" id="startDebateBtn" onclick="startDebate()">
                    <i class="fas fa-play"></i> START DEBATE
                </button>
                <button class="end-debate-btn" id="endDebateBtn" onclick="endDebate()">
                    <i class="fas fa-flag"></i> END DEBATE
                </button>
            </div>
            
            <div class="topic-display">
                <div class="topic-title">
                    <i class="fas fa-comments"></i> DEBATE TOPIC
                </div>
                <div class="topic-statement" id="topicStatement">Loading topic...</div>
            </div>
            
            <div class="score-display">
                <div class="score-box user-score-box">
                    <div class="score-label">YOUR SCORE</div>
                    <div class="score-value user-score" id="userScore">0</div>
                </div>
                <div class="score-box ai-score-box">
                    <div class="score-label" id="aiNameLabel">AI SCORE</div>
                    <div class="score-value ai-score" id="aiScore">0</div>
                </div>
                <div class="timer-container">
                    <div class="timer-label">TIME REMAINING</div>
                    <div class="timer" id="timer">05:00</div>
                </div>
            </div>
        </div>
        
        <!-- Voice Status -->
        <div class="voice-status voice-inactive" id="voiceStatus">
            <i class="fas fa-volume-mute"></i>
            <span>Voice: Ready to start</span>
        </div>
        
        <!-- Debate Arena -->
        <div class="debate-arena">
            <!-- User Panel -->
            <div class="participant" id="userPanel">
                <div class="participant-header user-header">
                    <div class="avatar-container user-avatar">
                        <div class="speaking-indicator" id="userSpeakingIndicator"></div>
                        <div class="character-emoji">ðŸ‘¤</div>
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            YOU
                            <span class="level-badge human-badge">HUMAN</span>
                        </div>
                        <div class="side-indicator pro-side" id="userSideIndicator">
                            <i class="fas fa-thumbs-up"></i>
                            ARGUING: <span id="userSideText">PRO</span>
                        </div>
                        <div class="voice-state" id="userVoiceState">
                            <i class="fas fa-microphone-slash"></i>
                            <span>Ready</span>
                        </div>
                    </div>
                </div>
                <div class="debate-content" id="userContent"></div>
            </div>
            
            <!-- AI Panel -->
            <div class="participant" id="aiPanel">
                <div class="participant-header ai-header">
                    <div class="avatar-container ai-avatar">
                        <img src="" alt="AI Opponent" class="character-image" id="aiCharacterImage">
                        <div class="speaking-indicator" id="aiSpeakingIndicator"></div>
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            <span id="aiNameDisplay">AI Opponent</span>
                            <span class="level-badge" id="aiLevelBadge">BEGINNER</span>
                        </div>
                        <div class="side-indicator con-side" id="aiSideIndicator">
                            <i class="fas fa-thumbs-down"></i>
                            ARGUING: <span id="aiSideText">CON</span>
                        </div>
                        <div class="voice-state" id="aiVoiceState">
                            <i class="fas fa-volume-mute"></i>
                            <span>Waiting</span>
                        </div>
                    </div>
                </div>
                <div class="debate-content" id="aiContent"></div>
                <div class="typing-indicator" id="aiTyping">
                    <div class="typing-dots"><span></span><span></span></div>
                    <span><span id="aiNameTyping">AI</span> is thinking...</span>
                </div>
            </div>
        </div>
        
        <!-- Voice Control Section -->
        <div class="voice-control-section" id="voiceControlSection" style="display: none;">
            <div class="input-toggle">
                <button class="toggle-btn active" id="voiceToggle" onclick="switchToVoice()">
                    <i class="fas fa-microphone"></i> VOICE
                </button>
                <button class="toggle-btn" id="textToggle" onclick="switchToText()">
                    <i class="fas fa-keyboard"></i> TEXT
                </button>
            </div>
            
            <div id="voiceInputArea">
                <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                    <div class="recording-dot"></div>
                    <span>Recording... Speak now!</span>
                </div>
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()" disabled>
                    <i class="fas fa-microphone"></i> CLICK TO RECORD
                </button>
            </div>
            
            <div class="text-input-area" id="textInputArea" style="display: none;">
                <textarea id="textArgument" placeholder="Type your argument... (Press Enter to send)" onkeydown="handleTextKeyPress(event)"></textarea>
                <button class="send-text-btn" id="sendTextBtn" onclick="sendTextArgument()" disabled>
                    <i class="fas fa-paper-plane"></i> SEND
                </button>
            </div>
        </div>
    </div>
    
    <!-- Result Screen -->
    <div class="result-screen" id="resultScreen">
        <div class="result-content">
            <h1 class="winner-title" id="winnerTitle">DEBATE COMPLETE</h1>
            <div class="final-score">
                <span class="user-final" id="finalUserScore">0</span>
                <span style="margin: 0 20px;">-</span>
                <span class="ai-final" id="finalAiScore">0</span>
            </div>
            <div class="score-breakdown">
                <div><div style="color: #00b7ff;">YOUR ARGUMENTS</div><div id="userArgumentsCount">0</div></div>
                <div><div style="color: #ff0080;">AI ARGUMENTS</div><div id="aiArgumentsCount">0</div></div>
            </div>
            <p class="result-message" id="resultMessage"></p>
            <div class="action-buttons">
                <button class="action-btn play-again-btn" onclick="playAgain()"><i class="fas fa-redo"></i> PLAY AGAIN</button>
                <button class="action-btn home-btn" onclick="goHome()"><i class="fas fa-home"></i> HOME</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const SERVER_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : window.location.origin;
        
        // Character database
        const CHARACTERS = {
            'luna': { 
                name: 'LUNA', 
                level: 'beginner', 
                voice: { gender: 'female', rate: 1.0, pitch: 1.2 },
                avatar: 'images/avatars/luna.jpeg',
                style: 'friendly and curious'
            },
            'athena': { 
                name: 'ATHENA', 
                level: 'intermediate', 
                voice: { gender: 'female', rate: 1.0, pitch: 1.0 },
                avatar: 'images/avatars/athena.jpeg',
                style: 'analytical and logical'
            },
            'leo': { 
                name: 'LEO', 
                level: 'beginner', 
                voice: { gender: 'male', rate: 1.2, pitch: 1.1 },
                avatar: 'images/avatars/leo.jpg',
                style: 'energetic and enthusiastic'
            },
            'titan': { 
                name: 'TITAN', 
                level: 'expert', 
                voice: { gender: 'male', rate: 0.9, pitch: 0.9 },
                avatar: 'images/avatars/titan.jpeg',
                style: 'authoritative and challenging'
            }
        };

        // ========== GAME STATE ==========
        let isDebateActive = false;
        let isRecording = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let userScore = 0;
        let aiScore = 0;
        let timeLeft = 300;
        let timerInterval = null;
        let userArgs = 0;
        let aiArgs = 0;
        let history = [];
        let character = null;
        let topic = '';
        let userSide = '';
        let aiSide = '';
        let isProcessing = false;
        let lastUserMessage = '';
        let messageCount = 0;
        let voices = [];
        let currentUtterance = null;

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            loadGameData();
            setupSpeechRecognition();
            loadVoices();
            updateTimerDisplay();
            
            // Test voice on load
            setTimeout(() => {
                console.log('Voices available:', voices.length);
                if (voices.length === 0) {
                    console.log('No voices found, will retry...');
                }
            }, 1000);
        });

        function loadVoices() {
            if (!synthesis) {
                console.error('Speech synthesis not supported');
                return;
            }
            
            voices = synthesis.getVoices();
            console.log('Initial voices:', voices.length);
            
            if (voices.length === 0) {
                synthesis.addEventListener('voiceschanged', () => {
                    voices = synthesis.getVoices();
                    console.log('Voices loaded after event:', voices.length);
                });
            }
        }

        function createParticles() {
            const container = document.getElementById('particlesContainer');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDuration = (Math.random() * 20 + 10) + 's';
                p.style.backgroundColor = ['#8e4ee7', '#00b7ff', '#ff0080'][Math.floor(Math.random() * 3)];
                container.appendChild(p);
            }
        }

        function loadGameData() {
            const opp = localStorage.getItem('selectedOpponent');
            const top = localStorage.getItem('debateTopic');
            const side = localStorage.getItem('userSide');
            
            if (!opp || !top || !side) {
                window.location.href = 'choose-ai.html';
                return;
            }
            
            character = CHARACTERS[opp] || CHARACTERS['luna'];
            character.id = opp;
            topic = top;
            userSide = side;
            aiSide = side === 'pro' ? 'con' : 'pro';
            
            document.getElementById('topicStatement').textContent = topic;
            document.getElementById('userSideText').textContent = userSide.toUpperCase();
            document.getElementById('userSideIndicator').className = `side-indicator ${userSide}-side`;
            document.getElementById('aiSideText').textContent = aiSide.toUpperCase();
            document.getElementById('aiSideIndicator').className = `side-indicator ${aiSide}-side`;
            document.getElementById('aiNameDisplay').textContent = character.name;
            document.getElementById('aiNameLabel').textContent = `${character.name} SCORE`;
            document.getElementById('aiNameTyping').textContent = character.name;
            
            const badge = document.getElementById('aiLevelBadge');
            badge.textContent = character.level.toUpperCase();
            badge.className = `level-badge ${character.level}-badge`;
            
            const img = document.getElementById('aiCharacterImage');
            img.src = character.avatar;
            
            addMessage('system', `ðŸŽ¤ Debate Topic: "${topic}"`);
            addMessage('system', `Your Position: ${userSide.toUpperCase()} | ${character.name}'s Position: ${aiSide.toUpperCase()}`);
            
            switchToText();
        }

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                document.getElementById('voiceToggle').style.display = 'none';
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            let finalTranscript = '';
            let recognitionTimeout = null;
            
            recognition.onstart = () => {
                console.log('Recognition started');
                document.getElementById('userVoiceState').innerHTML = '<i class="fas fa-microphone" style="color:#00ff88;"></i> Listening...';
                finalTranscript = '';
            };
            
            recognition.onresult = (event) => {
                if (recognitionTimeout) {
                    clearTimeout(recognitionTimeout);
                }
                
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (interimTranscript) {
                    document.getElementById('userVoiceState').innerHTML = '<i class="fas fa-microphone" style="color:#00ff88;"></i> Hearing: ' + interimTranscript.substring(0, 40) + '...';
                }
                
                if (finalTranscript.trim().length > 5) {
                    recognitionTimeout = setTimeout(() => {
                        if (finalTranscript.trim().length > 3 && isDebateActive && !isProcessing) {
                            lastUserMessage = finalTranscript.trim();
                            processUserInput(lastUserMessage, 'voice');
                            finalTranscript = '';
                        }
                    }, 1500);
                }
            };
            
            recognition.onerror = (e) => {
                console.log('Recognition error:', e.error);
                if (e.error === 'not-allowed') {
                    alert('Microphone access denied. Using text input.');
                    switchToText();
                }
                stopRecording();
            };
            
            recognition.onend = () => {
                if (finalTranscript.trim().length > 3 && isDebateActive && !isProcessing) {
                    lastUserMessage = finalTranscript.trim();
                    processUserInput(lastUserMessage, 'voice');
                }
                
                if (isRecording && isDebateActive) {
                    setTimeout(() => {
                        try { 
                            recognition.start(); 
                        } catch (e) {
                            console.log('Failed to restart recognition:', e);
                        }
                    }, 100);
                } else {
                    document.getElementById('userVoiceState').innerHTML = '<i class="fas fa-microphone-slash"></i> Ready';
                    document.getElementById('userSpeakingIndicator').style.display = 'none';
                    document.getElementById('userPanel').classList.remove('speaking');
                }
            };
        }

        // ========== INPUT MODES ==========
        function switchToVoice() {
            document.getElementById('voiceToggle').classList.add('active');
            document.getElementById('textToggle').classList.remove('active');
            document.getElementById('voiceInputArea').style.display = 'block';
            document.getElementById('textInputArea').style.display = 'none';
        }

        function switchToText() {
            document.getElementById('textToggle').classList.add('active');
            document.getElementById('voiceToggle').classList.remove('active');
            document.getElementById('voiceInputArea').style.display = 'none';
            document.getElementById('textInputArea').style.display = 'flex';
            document.getElementById('textArgument').focus();
            
            if (isRecording) {
                stopRecording();
            }
        }

        // ========== DEBATE CONTROL ==========
        function startDebate() {
            if (isDebateActive) return;
            
            isDebateActive = true;
            messageCount = 0;
            document.getElementById('startDebateBtn').disabled = true;
            
            document.getElementById('voiceControlSection').style.display = 'flex';
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('sendTextBtn').disabled = false;
            
            document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-volume-up" style="color:#00ff88;"></i> Voice: Active';
            document.getElementById('voiceStatus').className = 'voice-status voice-active';
            
            startTimer();
            
            // AI Introduction
            setTimeout(() => {
                if (!isDebateActive) return;
                const intro = generateIntroduction(character.name, topic, aiSide.toUpperCase(), character.level);
                addMessage('ai', intro);
                speakText(intro, () => {
                    addMessage('system', 'ðŸŽ¤ Your turn! Speak or type your argument.');
                });
            }, 1000);
        }

        // ========== VOICE RECORDING ==========
        async function toggleRecording() {
            if (!isRecording) {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    startRecording();
                } catch (e) {
                    alert('Microphone access denied. Using text input.');
                    switchToText();
                }
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            if (!recognition) {
                alert('Speech recognition not supported. Use text input.');
                return;
            }
            
            isRecording = true;
            document.getElementById('recordBtn').innerHTML = '<i class="fas fa-stop"></i> STOP';
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recordingIndicator').style.display = 'flex';
            document.getElementById('userSpeakingIndicator').style.display = 'block';
            document.getElementById('userPanel').classList.add('speaking');
            
            try {
                recognition.start();
            } catch (e) {
                console.log('Recognition start failed:', e);
                stopRecording();
            }
        }

        function stopRecording() {
            isRecording = false;
            if (recognition) {
                try { 
                    recognition.stop(); 
                } catch (e) {}
            }
            document.getElementById('recordBtn').innerHTML = '<i class="fas fa-microphone"></i> RECORD';
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recordingIndicator').style.display = 'none';
            document.getElementById('userSpeakingIndicator').style.display = 'none';
            document.getElementById('userPanel').classList.remove('speaking');
            document.getElementById('userVoiceState').innerHTML = '<i class="fas fa-microphone-slash"></i> Ready';
        }

        // ========== TEXT INPUT ==========
        function sendTextArgument() {
            const input = document.getElementById('textArgument');
            const text = input.value.trim();
            if (text && text.length >= 3 && isDebateActive && !isProcessing) {
                lastUserMessage = text;
                processUserInput(text, 'text');
                input.value = '';
            }
        }

        function handleTextKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextArgument();
            }
        }

        // ========== IMPROVED SCORING SYSTEM ==========
        // ========== FIXED SCORING SYSTEM ==========
function calculatePoints(text, isUser) {
    const lowerText = text.toLowerCase();
    const words = lowerText.split(' ');
    const wordCount = words.length;
    
    // Extract topic keywords (remove common words)
    const topicKeywords = topic.toLowerCase()
        .split(' ')
        .filter(w => w.length > 2 && !['the', 'and', 'for', 'are', 'not', 'but'].includes(w))
        .map(w => w.replace(/[^a-z]/g, ''));
    
    // Count topic matches
    let topicMatches = 0;
    topicKeywords.forEach(keyword => {
        if (keyword.length > 2 && lowerText.includes(keyword)) {
            topicMatches++;
        }
    });
    
    // Social greeting detection
    const socialGreetings = ['hello', 'hi', 'hey', 'namaste', 'good morning', 'good afternoon', 'good evening', 'how are you', 'nice to meet', 'pleasure', 'introduce', 'myself', 'name is', 'call me'];
    let socialScore = 0;
    socialGreetings.forEach(greeting => {
        if (lowerText.includes(greeting)) {
            socialScore++;
        }
    });
    
    // Argument quality indicators
    const hasReasoning = words.some(w => ['because', 'since', 'therefore', 'thus', 'hence', 'so'].includes(w));
    const hasEvidence = words.some(w => ['example', 'research', 'study', 'data', 'evidence', 'fact', 'statistics'].includes(w));
    const hasCounter = words.some(w => ['however', 'but', 'although', 'nevertheless', 'contrary', 'oppose'].includes(w));
    const hasConclusion = words.some(w => ['therefore', 'thus', 'conclusion', 'finally', 'ultimately'].includes(w));
    
    // Calculate base score (0-10 scale)
    let baseScore = 0;
    
    // --- PENALTIES (applied first) ---
    
    // Heavy penalty for pure social messages (no topic keywords)
    if (socialScore > 0 && topicMatches === 0 && wordCount < 10) {
        baseScore -= 3;
        if (isUser && messageCount > 1) {
            addMessage('system', 'âš ï¸ Off-topic social message penalized!');
        }
    }
    
    // Light penalty for mixing social with topic
    if (socialScore > 0 && topicMatches > 0) {
        baseScore -= 1;
    }
    
    // --- POSITIVE POINTS ---
    
    // Topic relevance (core of scoring)
    if (topicMatches >= 3) baseScore += 6;
    else if (topicMatches === 2) baseScore += 5;
    else if (topicMatches === 1) baseScore += 4;
    else if (topicMatches === 0 && wordCount > 10) {
        // Long but off-topic gets minimal points
        baseScore += 1;
    }
    
    // Argument quality bonuses (only if actually discussing topic)
    if (topicMatches > 0) {
        if (hasReasoning) baseScore += 1;
        if (hasEvidence) baseScore += 2; // Evidence is valuable
        if (hasCounter) baseScore += 1;
        if (hasConclusion) baseScore += 1;
        
        // Length bonus for substantial arguments
        if (wordCount > 20) baseScore += 1;
        if (wordCount > 40) baseScore += 1;
    }
    
    // --- LEVEL-BASED ADJUSTMENTS (fair but not crippling) ---
    
    if (isUser) {
        // User gets slight advantage against beginners
        if (character.level === 'beginner') {
            baseScore = Math.round(baseScore * 1.1); // Only 10% bonus
        } else if (character.level === 'expert') {
            baseScore = Math.round(baseScore * 0.95); // 5% penalty
        }
    } else {
        // AI strength adjustments - more subtle now
        if (character.level === 'beginner') {
            baseScore = Math.round(baseScore * 0.9); // 10% penalty for beginner AI
        } else if (character.level === 'intermediate') {
            baseScore = Math.round(baseScore * 1.0); // No adjustment
        } else if (character.level === 'expert') {
            baseScore = Math.round(baseScore * 1.1); // 10% bonus for expert
        }
    }
    
    // Ensure minimum score of 0, maximum of 10
    return Math.max(0, Math.min(10, baseScore));
}
        // ========== PROCESS USER INPUT ==========
        async function processUserInput(text, mode) {
            if (!isDebateActive || isProcessing) return;
            
            isProcessing = true;
            messageCount++;
            
            if (isRecording) {
                stopRecording();
            }
            
            const prefix = mode === 'voice' ? 'ðŸŽ¤ ' : 'âœï¸ ';
            addMessage('user', prefix + text);
            userArgs++;
            
            const userPoints = calculatePoints(text, true);
            userScore += userPoints;
            if (userPoints > 0) {
                showPoints('user', userPoints);
            }
            updateScores();
            
            document.getElementById('aiTyping').style.display = 'flex';
            
            try {
                const response = await fetch(`${SERVER_URL}/api/ai-response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userMessage: text,
                        characterId: character.id,
                        topic: topic,
                        userSide: userSide,
                        aiSide: aiSide,
                        conversationHistory: history.slice(-5)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById('aiTyping').style.display = 'none';
                
                if (data.response) {
                    addMessage('ai', data.response);
                    aiArgs++;
                    
                    const aiPoints = calculatePoints(data.response, false);
                    aiScore += aiPoints;
                    if (aiPoints > 0) {
                        showPoints('ai', aiPoints);
                    }
                    updateScores();
                    
                    // Use improved speak function
                    await speakText(data.response, () => {
                        isProcessing = false;
                        
                        if (document.getElementById('voiceToggle').classList.contains('active') && isDebateActive && !isRecording) {
                            setTimeout(() => {
                                if (isDebateActive && !isRecording && !isProcessing) {
                                    startRecording();
                                }
                            }, 500);
                        }
                    });
                } else {
                    throw new Error('No response from AI');
                }
                
            } catch (error) {
                console.error('API call failed:', error);
                document.getElementById('aiTyping').style.display = 'none';
                
                const fallbackResponse = generateSmartFallback(text, topic, aiSide, character);
                
                addMessage('ai', fallbackResponse + ' (offline mode)');
                aiArgs++;
                
                const aiPoints = calculatePoints(fallbackResponse, false);
                aiScore += aiPoints;
                if (aiPoints > 0) {
                    showPoints('ai', aiPoints);
                }
                updateScores();
                
                await speakText(fallbackResponse, () => {
                    isProcessing = false;
                    
                    if (document.getElementById('voiceToggle').classList.contains('active') && isDebateActive && !isRecording) {
                        setTimeout(() => {
                            if (isDebateActive && !isRecording && !isProcessing) {
                                startRecording();
                            }
                        }, 500);
                    }
                });
            }
        }

        // ========== IMPROVED SPEECH FUNCTION ==========
        function speakText(text, onEnd) {
            return new Promise((resolve) => {
                if (!synthesis) {
                    console.error('Speech synthesis not supported');
                    if (onEnd) onEnd();
                    resolve();
                    return;
                }
                
                // Cancel any ongoing speech
                if (currentUtterance) {
                    synthesis.cancel();
                    currentUtterance = null;
                }
                
                // Small delay to ensure clean start
                setTimeout(() => {
                    try {
                        // Get fresh voices
                        const availableVoices = synthesis.getVoices();
                        
                        const utterance = new SpeechSynthesisUtterance(text);
                        currentUtterance = utterance;
                        
                        // Set voice properties from character
                        utterance.rate = character.voice.rate || 1.0;
                        utterance.pitch = character.voice.pitch || 1.0;
                        utterance.volume = 1;
                        
                        // Try to find appropriate voice
                        if (availableVoices.length > 0) {
                            // First try to find voice matching gender
                            let selectedVoice = null;
                            
                            if (character.voice.gender === 'female') {
                                selectedVoice = availableVoices.find(v => 
                                    v.name.includes('Samantha') || 
                                    v.name.includes('Karen') || 
                                    v.name.includes('Victoria') ||
                                    v.name.includes('Google UK Female') ||
                                    v.name.includes('Female')
                                );
                            } else {
                                selectedVoice = availableVoices.find(v => 
                                    v.name.includes('David') || 
                                    v.name.includes('Mark') || 
                                    v.name.includes('Daniel') ||
                                    v.name.includes('Google UK Male') ||
                                    v.name.includes('Male')
                                );
                            }
                            
                            // If no gender match, just use any English voice
                            if (!selectedVoice) {
                                selectedVoice = availableVoices.find(v => v.lang.includes('en-'));
                            }
                            
                            if (selectedVoice) {
                                utterance.voice = selectedVoice;
                                console.log('Using voice:', selectedVoice.name);
                            }
                        }
                        
                        // Set up event handlers
                        utterance.onstart = () => {
                            console.log('Speech started');
                            document.getElementById('aiSpeakingIndicator').style.display = 'block';
                            document.getElementById('aiPanel').classList.add('speaking');
                        };
                        
                        utterance.onend = () => {
                            console.log('Speech ended');
                            document.getElementById('aiSpeakingIndicator').style.display = 'none';
                            document.getElementById('aiPanel').classList.remove('speaking');
                            currentUtterance = null;
                            if (onEnd) onEnd();
                            resolve();
                        };
                        
                        utterance.onerror = (event) => {
                            console.error('Speech error:', event);
                            document.getElementById('aiSpeakingIndicator').style.display = 'none';
                            document.getElementById('aiPanel').classList.remove('speaking');
                            currentUtterance = null;
                            if (onEnd) onEnd();
                            resolve();
                        };
                        
                        // Speak
                        synthesis.speak(utterance);
                        
                    } catch (e) {
                        console.error('Speech error:', e);
                        if (onEnd) onEnd();
                        resolve();
                    }
                }, 100);
            });
        }

        // ========== SMART FALLBACK ==========
        function generateSmartFallback(userMessage, topic, aiSide, character) {
            const words = userMessage.toLowerCase().split(' ');
            const stopWords = ['i', 'you', 'the', 'and', 'but', 'for', 'with', 'that', 'this', 'have', 'from', 'they', 'think', 'believe', 'feel', 'know', 'just', 'like', 'about', 'because', 'really', 'very', 'much'];
            const keyWords = words.filter(w => w.length > 3 && !stopWords.includes(w)).slice(0, 2);
            const keyPoint = keyWords.length > 0 ? keyWords.join(' ') : 'your point';
            
            if (character.id === 'luna') {
                return `I hear what you're saying about ${keyPoint}! That's a really important concern about "${topic}". But from my perspective, I think there might be another way to look at this. Have you considered that maybe there are positive aspects too?`;
            }
            else if (character.id === 'athena') {
                return `Your point about ${keyPoint} regarding "${topic}" raises interesting questions. However, from a logical standpoint, we should also consider the counter-arguments. How would you respond to that?`;
            }
            else if (character.id === 'leo') {
                return `WOW! That's an AMAZING point about ${keyPoint}! I'm so excited you brought that up about "${topic}"! But from my SUPER enthusiastic perspective, I think there's so much more to consider! Don't you think there might be another side to this?`;
            }
            else if (character.id === 'titan') {
                return `Your assertion regarding ${keyPoint} in relation to "${topic}" requires deeper examination. The logical framework supporting my position suggests that your premise may be incomplete. Can you provide more evidence to substantiate your claim?`;
            }
            
            return `You mentioned ${keyPoint} about "${topic}" - that's interesting! From my perspective, I see things a bit differently. What do you think?`;
        }

        // ========== CHARACTER INTRODUCTION ==========
        function generateIntroduction(characterName, topic, side, level) {
            if (characterName === 'LUNA') {
                return `Hi! I'm Luna! I'm so excited to talk about "${topic}" with you! I'll be arguing the ${side} side. I think this is such an interesting topic! Let's Start!!`;
            } else if (characterName === 'LEO') {
                return `Hey there! Leo here! WOW, "${topic}" - what an amazing topic to debate! I'm taking the ${side} position and I'm SUPER excited about it! Let's do this!`;
            } else if (characterName === 'ATHENA') {
                return `Greetings. I am Athena. We will be debating "${topic}" today. I will be arguing the ${side} position. This topic presents numerous logical dimensions worth exploring. Let us begin.`;
            } else if (characterName === 'TITAN') {
                return `I am Titan. The topic of "${topic}" demands rigorous intellectual examination. I shall argue the ${side} position with philosophical precision. I expect nothing less than your best reasoning.`;
            }
            return `Let's debate "${topic}". I'm arguing ${side}.`;
        }

        // ========== UI HELPERS ==========
        function addMessage(sender, text) {
            const container = sender === 'user' ? 'userContent' : sender === 'ai' ? 'aiContent' : 'userContent';
            const div = document.getElementById(container);
            
            const msg = document.createElement('div');
            msg.className = `message ${sender}-message`;
            
            const time = new Date();
            const timeStr = `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}:${time.getSeconds().toString().padStart(2,'0')}`;
            
            msg.innerHTML = `
                <div class="message-sender">
                    <i class="fas fa-${sender === 'user' ? 'user' : sender === 'ai' ? 'robot' : 'info-circle'}"></i>
                    ${sender === 'user' ? 'YOU' : sender === 'ai' ? character.name : 'SYSTEM'}
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-text">${text}</div>
            `;
            
            div.appendChild(msg);
            div.scrollTop = div.scrollHeight;
            
            history.push({ role: sender, text, time });
        }

        function showPoints(target, points) {
            if (points <= 0) return;
            
            const panel = target === 'user' ? document.getElementById('userPanel') : document.getElementById('aiPanel');
            const rect = panel.getBoundingClientRect();
            const notif = document.createElement('div');
            notif.className = 'points-notification';
            notif.style.background = target === 'user' ? '#00b7ff' : '#ff0080';
            notif.style.left = (rect.left + rect.width - 80) + 'px';
            notif.style.top = (rect.top + 30) + 'px';
            notif.textContent = `+${points}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 1500);
        }

        function updateScores() {
            document.getElementById('userScore').textContent = userScore;
            document.getElementById('aiScore').textContent = aiScore;
        }

        // ========== TIMER ==========
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    endDebate();
                    return;
                }
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft === 60) {
                    addMessage('system', 'â° One minute left!');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            const timer = document.getElementById('timer');
            timer.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            if (timeLeft <= 60) timer.classList.add('warning');
        }

        // ========== END DEBATE ==========
        function endDebate() {
            if (!isDebateActive) {
                window.location.href = 'index.html';
                return;
            }
            
            isDebateActive = false;
            isProcessing = false;
            
            clearInterval(timerInterval);
            
            if (isRecording) {
                stopRecording();
            }
            
            if (synthesis && currentUtterance) {
                synthesis.cancel();
                currentUtterance = null;
            }
            
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('sendTextBtn').disabled = true;
            document.getElementById('endDebateBtn').disabled = true;
            
            let winner = 'DRAW';
            let msg = "It's a tie! Both sides presented compelling arguments.";
            
            if (userScore > aiScore) {
                winner = 'YOU';
                msg = `ðŸŽ‰ Congratulations! You won against ${character.name}! Your arguments were particularly strong.`;
            } else if (aiScore > userScore) {
                winner = character.name;
                msg = `${character.name} wins this round! A worthy opponent who presented a solid case.`;
            }
            
            document.getElementById('winnerTitle').textContent = `${winner} WINS!`;
            document.getElementById('finalUserScore').textContent = userScore;
            document.getElementById('finalAiScore').textContent = aiScore;
            document.getElementById('userArgumentsCount').textContent = userArgs;
            document.getElementById('aiArgumentsCount').textContent = aiArgs;
            document.getElementById('resultMessage').textContent = msg;
            document.getElementById('resultScreen').style.display = 'flex';
            
            createConfetti();
        }

        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            for (let i = 0; i < 100; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + '%';
                c.style.animationDelay = Math.random() * 2 + 's';
                c.style.backgroundColor = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff'][Math.floor(Math.random()*5)];
                container.appendChild(c);
                setTimeout(() => c.remove(), 5000);
            }
        }

        function playAgain() {
            userScore = 0;
            aiScore = 0;
            userArgs = 0;
            aiArgs = 0;
            timeLeft = 300;
            isDebateActive = false;
            isProcessing = false;
            history = [];
            lastUserMessage = '';
            messageCount = 0;
            
            document.getElementById('userContent').innerHTML = '';
            document.getElementById('aiContent').innerHTML = '';
            document.getElementById('confettiContainer').innerHTML = '';
            document.getElementById('resultScreen').style.display = 'none';
            
            document.getElementById('startDebateBtn').disabled = false;
            document.getElementById('endDebateBtn').disabled = false;
            document.getElementById('voiceControlSection').style.display = 'none';
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('sendTextBtn').disabled = true;
            
            document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-volume-mute"></i> Voice: Ready';
            document.getElementById('voiceStatus').className = 'voice-status voice-inactive';
            document.getElementById('userVoiceState').innerHTML = '<i class="fas fa-microphone-slash"></i> Ready';
            
            updateTimerDisplay();
            
            if (synthesis && currentUtterance) {
                synthesis.cancel();
                currentUtterance = null;
            }
            
            loadGameData();
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Load voices when available
        if (synthesis) {
            synthesis.onvoiceschanged = () => {
                voices = synthesis.getVoices();
                console.log('Voices updated:', voices.length);
            };
        }
    </script>
</body>
</html>